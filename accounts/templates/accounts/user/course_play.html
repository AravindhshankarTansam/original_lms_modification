{% extends "accounts/user/base.html" %}
{% load static %}

{% block title %}
{{ course.title }}
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{% static 'css/course_play.css' %}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="catalog-toolbar">
  <div class="d-flex align-items-center gap-3">
    <div class="breadcrumb-custom">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M3 10h4l3 9 4-18 3 9h4" stroke="#c2c2c2" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <a href="{% url 'dashboard' %}" class="muted text-decoration-none text-reset">Dashboard</a>
      <span class="breadcrumb-separator">â€º</span>
      <a href="{% url 'courses_catalog' %}" class="muted text-decoration-none text-reset">Course Catalog</a>
      <span class="breadcrumb-separator">â€º</span>
      <span class="fw-semibold">{{ course.title }}</span>
    </div>
  </div>
</div>

<div class="course-header">
  {{ course.title }}
</div>

<div class="main-container">
  <!-- ===== MAIN LESSON VIEWER ===== -->
  <div class="video-section">
    <div class="video-container text-center position-relative" id="mediaContainer">
      {% if first_chapter %}
    {% if first_chapter.material_type == 'video' and first_chapter.material_file %}
        <!-- ðŸŽ¥ Video Player -->
        <video id="lessonVideo"
               controls preload="metadata"
               controlsList="nodownload"
               oncontextmenu="return false;"
               width="100%">
          <source src="{{ first_chapter.material_file.url }}" type="video/mp4">
        </video>
        <iframe id="lessonViewer" class="d-none" width="100%" height="500px"></iframe>

   {% elif first_chapter.material_file and first_chapter.material_type == 'pdf' %}
    <iframe id="lessonViewer"
            src="{{ request.scheme }}://{{ request.get_host }}{{ first_chapter.material_file.url }}#toolbar=0&scrollbar=0"
            width="100%" height="600px"
            style="border: none;"></iframe>
    <video id="lessonVideo" class="d-none"></video>


    {% elif first_chapter.material_file and first_chapter.material_type == 'ppt' %}
        <!-- ðŸŸ¢ PPT Viewer (No Download) -->
        <iframe id="lessonViewer"
                src="https://view.officeapps.live.com/op/embed.aspx?src={{ request.scheme }}://{{ request.get_host }}{{ first_chapter.material_file.url }}"
                width="100%" height="600px"
                style="border: none;"></iframe>
        <video id="lessonVideo" class="d-none"></video>

    {% else %}
        <!-- ðŸª„ Default if file exists but type unknown -->
        <video id="lessonVideo" controls preload="metadata" width="100%">
          <source src="{% static 'videos/default_intro.mp4' %}" type="video/mp4">
        </video>
        <iframe id="lessonViewer" class="d-none" width="100%" height="500px"></iframe>

    {% endif %}

{% else %}
    <!-- ðŸª„ Default if no chapter found -->
    <video id="lessonVideo" controls preload="metadata" width="100%">
      <source src="{% static 'videos/default_intro.mp4' %}" type="video/mp4">
    </video>
    <iframe id="lessonViewer" class="d-none" width="100%" height="500px"></iframe>

{% endif %}

    </div>

    <!-- ===== TABS ===== -->
    <ul class="nav nav-tabs mt-4" id="courseTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="lesson-details-tab" data-bs-toggle="tab" data-bs-target="#lesson-details" type="button" role="tab">Lesson Details</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">Instructions</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews</button>
      </li>
    </ul>

    <div class="tab-content p-3" id="courseTabContent">
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <p>{{ course.description|safe }}</p>
      </div>
      <div class="tab-pane fade" id="lesson-details" role="tabpanel">
        <p>Lesson details will appear here.</p>
      </div>
      <div class="tab-pane fade" id="resources" role="tabpanel">
        <p>{{ course.overview|default:"No additional instructions available."|safe }}</p>
      </div>
      <div class="tab-pane fade" id="reviews" role="tabpanel">
        <p>No reviews yet.</p>
      </div>
    </div>
  </div>

  <!-- ===== SIDEBAR (MODULES + CHAPTERS) ===== -->
  <div class="course-sidebar">
    <div class="progress-section mb-4">
      <label class="fw-semibold mb-1">Course Progress</label>
      <div class="progress-wrapper">
        <div class="progress-bar-custom" id="progressBar"></div>
      </div>
      <div class="small text-muted" id="progressText">0% Completed</div>
    </div>

    {% if modules %}
      {% for module in modules %}
        <div class="section mb-4">
          <h6 class="fw-bold">{{ module.title }}</h6>
          <ul class="lesson-list list-unstyled ms-2 mt-1">
            {% if module.chapters.all %}
              {% for chapter in module.chapters.all %}
                <li class="lesson-item d-flex align-items-center gap-2 py-1"
                    data-chapter-id="{{ chapter.id }}"
                    data-type="{{ chapter.material_type }}"
                    data-url="{% if chapter.material_file %}{{ request.scheme }}://{{ request.get_host }}{{ chapter.material_file.url }}{% else %}{% static 'videos/default_intro.mp4' %}{% endif %}"
                    data-title="{{ chapter.title }}">
                  
                  <span class="lesson-title">
                    {{ chapter.title }}
                    {% if not chapter.material_file %}
                      <small class="text-muted">(No file uploaded)</small>
                    {% endif %}
                  </span>
                </li>
              {% endfor %}
            {% else %}
              <li class="lesson-item text-muted">No chapters in this module</li>
            {% endif %}
          </ul>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No modules found in this course.</p>
    {% endif %}
  </div>

</div>
<script src="{% static 'js/course_play.js' %}"></script>
{% endblock %}


