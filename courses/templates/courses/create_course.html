{% extends "accounts/admin/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <!-- ===================== HEADER ===================== -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="m-0">Courses</h1>
    <button type="button" class="btn btn-primary fw-semibold" id="createCourseBtn" data-bs-toggle="modal" data-bs-target="#courseModal">
      + Create New Course
    </button>
  </div>

  <!-- ===================== COURSE TABLE ===================== -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white fw-semibold">Saved Courses</div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover m-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Course Title</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="courseTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===================== COURSE MODAL ===================== -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-semibold" id="courseModalLabel">Create New Course</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="courseForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">

          <!-- ===================== COURSE DETAILS ===================== -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white fw-semibold">Course Details</div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">Course Title</label>
                <input type="text" class="form-control" id="courseTitle" required>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Course Description</label>
                <div id="courseDescriptionEditor" class="quill-editor"></div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Course Image</label>
                <input type="file" class="form-control" id="courseImage" accept=".jpg,.jpeg,.png">
                <small class="text-muted">Only JPG, JPEG, PNG formats allowed.</small>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Overview</label>
                <div id="overviewEditor" class="quill-editor"></div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Requirements</label>
                <div id="requirementsEditor" class="quill-editor"></div>
              </div>

              
            </div>
          </div>

          <!-- ===================== MODULES ===================== -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between align-items-center">
              Modules
              <button type="button" id="addModuleBtn" class="btn btn-light btn-sm fw-semibold">+ Add Module</button>
            </div>
            <div class="card-body" id="modulesContainer"></div>
          </div>
        </div>

<div class="modal-footer d-flex justify-content-between align-items-center">
  <!-- Left: Cancel -->
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

  <!-- Center: Active/Inactive toggle -->
  <div class="form-check form-switch mb-0">
    <input class="form-check-input" type="checkbox" id="courseStatus" checked>
    <label class="form-check-label fw-semibold ms-2" for="courseStatus">Active</label>
  </div>

  <!-- Right: Save -->
  <button type="button" id="saveCourseBtn" class="btn btn-success fw-semibold">Save Course</button>
</div>

      </form>
    </div>
  </div>
</div>

<!-- ===================== STYLES ===================== -->
<style>
  .modal-dialog-scrollable .modal-body {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }
  .quill-editor {
    height: 150px;
  }
  .bg-light, .bg-white { border: 1px solid #dee2e6; }
</style>

<!-- ===================== SCRIPTS ===================== -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  const courseDescriptionEditor = new Quill('#courseDescriptionEditor', { theme: 'snow' });
  const overviewEditor = new Quill('#overviewEditor', { theme: 'snow' });
  const requirementsEditor = new Quill('#requirementsEditor', { theme: 'snow' });

  const modulesContainer = document.getElementById("modulesContainer");
  const addModuleBtn = document.getElementById("addModuleBtn");
  const courseTableBody = document.getElementById("courseTableBody");
  const saveBtn = document.getElementById("saveCourseBtn");

  let courses = [];
  let editCourseId = null;

  // ===================== MODULE LOGIC =====================
  function addModule(existing = null) {
    const index = modulesContainer.children.length + 1;
    const moduleDiv = document.createElement("div");
    moduleDiv.className = "border rounded p-3 mb-3 bg-light";
    moduleDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold">Module ${index}</h5>
        <button type="button" class="btn btn-sm btn-danger removeModuleBtn">Remove Module</button>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Module Title</label>
        <input type="text" class="form-control moduleTitle" value="${existing?.title || ''}" required>
      </div>

      <!-- Chapters -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label fw-semibold">Chapters</label>
          <button type="button" class="btn btn-outline-primary btn-sm addChapterBtn">+ Add Chapter</button>
        </div>
        <div class="chaptersContainer"></div>
      </div>

      <!-- Questions -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label fw-semibold">Questions</label>
          <button type="button" class="btn btn-outline-secondary btn-sm addQuestionBtn">+ Add Question</button>
        </div>
        <div class="questionsContainer"></div>
      </div>
    `;
    modulesContainer.appendChild(moduleDiv);

    moduleDiv.querySelector(".removeModuleBtn").addEventListener("click", () => moduleDiv.remove());

    // CHAPTER
    const addChapterBtn = moduleDiv.querySelector(".addChapterBtn");
    const chaptersContainer = moduleDiv.querySelector(".chaptersContainer");
    addChapterBtn.addEventListener("click", () => addChapter(chaptersContainer));

    // QUESTION
    const addQuestionBtn = moduleDiv.querySelector(".addQuestionBtn");
    const questionsContainer = moduleDiv.querySelector(".questionsContainer");
    addQuestionBtn.addEventListener("click", () => addQuestion(questionsContainer));
  }

  function addChapter(container, existing = null) {
    const index = container.children.length + 1;
    const chDiv = document.createElement("div");
    chDiv.className = "border p-3 mb-2 rounded bg-white";
    chDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold">Chapter ${index}</h6>
        <button type="button" class="btn btn-sm btn-danger removeChapterBtn">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Chapter Title</label>
        <input type="text" class="form-control chapterTitle" value="${existing?.title || ''}" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Description</label>
        <div class="chapterEditor quill-editor"></div>
      </div>
      <div class="mb-2">
        <label class="form-label">Study Material</label>
        <select class="form-select materialType">
          <option disabled selected>Select Type</option>
          <option value="video">Video</option>
          <option value="pdf">PDF</option>
          <option value="ppt">PPT</option>
        </select>
        <input type="file" class="form-control mt-2 materialFile" accept=".mp4,.pdf,.ppt,.pptx">
      </div>
    `;
    container.appendChild(chDiv);
    new Quill(chDiv.querySelector(".chapterEditor"), { theme: "snow" });
    chDiv.querySelector(".removeChapterBtn").addEventListener("click", () => chDiv.remove());
  }

  function addQuestion(container, existing = null) {
    const index = container.children.length + 1;
    const qDiv = document.createElement("div");
    qDiv.className = "border p-3 mb-2 rounded bg-white";
    qDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold">Question ${index}</h6>
        <button type="button" class="btn btn-sm btn-danger removeQuestionBtn">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Question Type</label>
        <select class="form-select questionType">
          <option disabled selected>Select Type</option>
          <option value="mcq">Multiple Choice</option>
          <option value="truefalse">True / False</option>
          <option value="short">Short Answer</option>
        </select>
      </div>
      <div class="questionDetails"></div>
    `;
    container.appendChild(qDiv);

    qDiv.querySelector(".removeQuestionBtn").addEventListener("click", () => qDiv.remove());
    const typeSelect = qDiv.querySelector(".questionType");
    const detailsDiv = qDiv.querySelector(".questionDetails");
    typeSelect.addEventListener("change", () => {
      const type = typeSelect.value;
      detailsDiv.innerHTML = "";
      if (type === "mcq") {
        detailsDiv.innerHTML = `
          <label class="form-label">Question</label>
          <input type="text" class="form-control mb-2 questionText" placeholder="Enter question">
          <label>Options</label>
          <input type="text" class="form-control mb-1 option1" placeholder="Option 1">
          <input type="text" class="form-control mb-1 option2" placeholder="Option 2">
          <input type="text" class="form-control mb-1 option3" placeholder="Option 3">
          <input type="text" class="form-control mb-1 option4" placeholder="Option 4">
          <input type="text" class="form-control correctAnswer" placeholder="Correct Answer">
        `;
      } else if (type === "truefalse") {
        detailsDiv.innerHTML = `
          <label class="form-label">Statement</label>
          <input type="text" class="form-control mb-2 questionText" placeholder="Enter statement">
          <select class="form-select correctAnswer">
            <option value="True">True</option>
            <option value="False">False</option>
          </select>
        `;
      } else {
        detailsDiv.innerHTML = `
          <label class="form-label">Question</label>
          <input type="text" class="form-control mb-2 questionText" placeholder="Enter question">
          <input type="text" class="form-control correctAnswer" placeholder="Expected Answer">
        `;
      }
    });
  }

  // ===================== SAVE COURSE =====================
  saveBtn.addEventListener("click", () => {
    const title = document.getElementById("courseTitle").value.trim();
    if (!title) return alert("Please enter course title");

    const courseObj = {
      id: editCourseId || Date.now(),
      title,
      description: courseDescriptionEditor.root.innerHTML,
      overview: overviewEditor.root.innerHTML,
      requirements: requirementsEditor.root.innerHTML,
      status: document.getElementById("courseStatus").checked ? "Active" : "Inactive",
      modules: []
    };

    modulesContainer.querySelectorAll(".border.rounded.bg-light").forEach(mod => {
      const modObj = {
        title: mod.querySelector(".moduleTitle").value,
        chapters: [],
        questions: []
      };
      mod.querySelectorAll(".chaptersContainer > div").forEach(ch => {
        const editor = ch.querySelector(".chapterEditor").__quill;
        modObj.chapters.push({
          title: ch.querySelector(".chapterTitle").value,
          desc: editor.root.innerHTML,
          type: ch.querySelector(".materialType").value
        });
      });
      mod.querySelectorAll(".questionsContainer > div").forEach(q => {
        const type = q.querySelector(".questionType").value;
        const qText = q.querySelector(".questionText")?.value || "";
        const cAns = q.querySelector(".correctAnswer")?.value || "";
        modObj.questions.push({ type, qText, cAns });
      });
      courseObj.modules.push(modObj);
    });

    if (editCourseId) {
      const idx = courses.findIndex(c => c.id === editCourseId);
      courses[idx] = courseObj;
      editCourseId = null;
    } else {
      courses.push(courseObj);
    }
    renderCourses();
    resetForm();
    bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
  });

  // ===================== RENDER COURSES =====================
  function renderCourses() {
    courseTableBody.innerHTML = "";
    courses.forEach((c, i) => {
      courseTableBody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${c.title}</td>
          <td><span class="badge bg-${c.status === "Active" ? "success" : "secondary"}">${c.status}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" onclick="editCourse(${c.id})">Edit</button>
          </td>
        </tr>
      `;
    });
  }

  // ===================== EDIT COURSE =====================
  window.editCourse = (id) => {
    const course = courses.find(c => c.id === id);
    if (!course) return;
    document.getElementById("courseModalLabel").innerText = "Edit Course";
    document.getElementById("courseTitle").value = course.title;
    courseDescriptionEditor.root.innerHTML = course.description;
    overviewEditor.root.innerHTML = course.overview;
    requirementsEditor.root.innerHTML = course.requirements;
    document.getElementById("courseStatus").checked = course.status === "Active";
    modulesContainer.innerHTML = "";
    course.modules.forEach(m => {
      addModule(m);
    });
    editCourseId = id;
    new bootstrap.Modal(document.getElementById('courseModal')).show();
  };

  // ===================== RESET FORM =====================
  function resetForm() {
    document.getElementById("courseForm").reset();
    courseDescriptionEditor.setContents([]);
    overviewEditor.setContents([]);
    requirementsEditor.setContents([]);
    modulesContainer.innerHTML = "";
    document.getElementById("courseModalLabel").innerText = "Create New Course";
  }

  addModuleBtn.addEventListener("click", () => addModule());
</script>
{% endblock %}
