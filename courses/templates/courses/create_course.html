{% extends "accounts/admin/base.html" %}
{% load static %}

{% block content %}
<link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
<link rel="shortcut icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

<div class="container-fluid">
    <script id="courses-data" type="application/json">{{ courses_json|safe }}</script>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="m-0">Create / Edit Course</h1>
        <a href="{% url 'course_table' %}" class="btn btn-secondary fw-semibold">‚Üê Back to Courses</a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="courseForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="courseId" name="course_id">

                <!-- COURSE DETAILS -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white fw-semibold">Course Details</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Course Title</label>
                            <input type="text" class="form-control" id="courseTitle" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Course Description</label>
                            <div id="courseDescriptionEditor" class="quill-editor"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Course Image</label>
                            <input type="file" class="form-control" id="courseImage" accept=".jpg,.jpeg,.png">
                            <small class="text-muted">Only JPG, JPEG, PNG formats allowed.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Overview</label>
                            <div id="overviewEditor" class="quill-editor"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Requirements</label>
                            <div id="requirementsEditor" class="quill-editor"></div>
                        </div>
                    </div>
                </div>

                <!-- MODULES -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between align-items-center">
                        Modules
                        <button type="button" id="addModuleBtn" class="btn btn-light btn-sm fw-semibold">+ Add Module</button>
                    </div>
                    <div class="card-body" id="modulesContainer"></div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="courseStatus" checked>
                        <label class="form-check-label fw-semibold ms-2" for="courseStatus">Active</label>
                    </div>
                    <button type="button" id="saveCourseBtn" class="btn btn-success fw-semibold">Save Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .quill-editor { height: 150px; }
    .bg-light, .bg-white { border: 1px solid #dee2e6; }
</style>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
const modulesContainer = document.getElementById("modulesContainer");
const addModuleBtn = document.getElementById("addModuleBtn");
const saveBtn = document.getElementById("saveCourseBtn");

// Initialize Quill editors
const courseDescriptionEditor = new Quill('#courseDescriptionEditor', { theme: 'snow' });
const overviewEditor = new Quill('#overviewEditor', { theme: 'snow' });
const requirementsEditor = new Quill('#requirementsEditor', { theme: 'snow' });

// Load courses JSON
let rawDataEl = document.getElementById('courses-data');
let courses = [];
if (rawDataEl) {
    try { courses = JSON.parse(rawDataEl.textContent.trim() || '[]'); }
    catch (e) { console.error("Invalid courses-data JSON", e); }
}

// ---------------- MODULE / CHAPTER / QUESTION ----------------
function addModule(existing = null) {
    const index = modulesContainer.children.length + 1;
    const moduleDiv = document.createElement("div");
    moduleDiv.className = "border rounded p-3 mb-3 bg-light";
    moduleDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold">Module ${index}</h5>
            <button type="button" class="btn btn-sm btn-danger removeModuleBtn">Remove Module</button>
        </div>
        <div class="mb-3">
            <label class="form-label fw-semibold">Module Title</label>
            <input type="text" class="form-control moduleTitle" value="${existing?.title || ''}" required>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-semibold">Chapters</label>
                <button type="button" class="btn btn-outline-primary btn-sm addChapterBtn">+ Add Chapter</button>
            </div>
            <div class="chaptersContainer"></div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-semibold">Questions</label>
                <button type="button" class="btn btn-outline-secondary btn-sm addQuestionBtn">+ Add Question</button>
            </div>
            <div class="questionsContainer"></div>
        </div>
    `;
    modulesContainer.appendChild(moduleDiv);

    moduleDiv.querySelector(".removeModuleBtn").addEventListener("click", () => moduleDiv.remove());
    const chaptersContainer = moduleDiv.querySelector(".chaptersContainer");
    moduleDiv.querySelector(".addChapterBtn").addEventListener("click", () => addChapter(chaptersContainer));
    const questionsContainer = moduleDiv.querySelector(".questionsContainer");
    moduleDiv.querySelector(".addQuestionBtn").addEventListener("click", () => addQuestion(questionsContainer));

    if (existing?.chapters) existing.chapters.forEach(ch => addChapter(chaptersContainer, ch));
    if (existing?.questions) existing.questions.forEach(q => addQuestion(questionsContainer, q));
}

function addChapter(container, existing = null) {
    const index = container.children.length + 1;
    const chDiv = document.createElement("div");
    chDiv.className = "border p-3 mb-2 rounded bg-white";
    chDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold">Chapter ${index}</h6>
            <button type="button" class="btn btn-sm btn-danger removeChapterBtn">Remove</button>
        </div>
        <div class="mb-2">
            <label class="form-label">Chapter Title</label>
            <input type="text" class="form-control chapterTitle" value="${existing?.title || ''}" required>
        </div>
        <div class="mb-2">
            <label class="form-label">Description</label>
            <div class="chapterEditor quill-editor"></div>
        </div>
        <div class="mb-2">
            <label class="form-label">Study Material</label>
            <select class="form-select materialType">
                <option disabled selected>Select Type</option>
                <option value="video" ${existing?.type === "video" ? "selected" : ""}>Video</option>
                <option value="pdf" ${existing?.type === "pdf" ? "selected" : ""}>PDF</option>
                <option value="ppt" ${existing?.type === "ppt" ? "selected" : ""}>PPT</option>
            </select>
            <input type="file" class="form-control mt-2 materialFile" accept=".mp4,.pdf,.ppt,.pptx">
        </div>
    `;
    container.appendChild(chDiv);

    const quillInstance = new Quill(chDiv.querySelector(".chapterEditor"), { theme: "snow" });
    if (existing?.desc) quillInstance.root.innerHTML = existing.desc;

    chDiv.querySelector(".removeChapterBtn").addEventListener("click", () => chDiv.remove());
}

function addQuestion(container, existing = null) {
    const index = container.children.length + 1;
    const qDiv = document.createElement("div");
    qDiv.className = "border p-3 mb-2 rounded bg-white";
    qDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold">Question ${index}</h6>
            <button type="button" class="btn btn-sm btn-danger removeQuestionBtn">Remove</button>
        </div>
        <div class="mb-2">
            <label class="form-label">Question Type</label>
            <select class="form-select questionType">
                <option disabled selected>Select Type</option>
                <option value="mcq" ${existing?.type === "mcq" ? "selected" : ""}>Multiple Choice</option>
                <option value="truefalse" ${existing?.type === "truefalse" ? "selected" : ""}>True / False</option>
                <option value="short" ${existing?.type === "short" ? "selected" : ""}>Short Answer</option>
            </select>
        </div>
        <div class="questionDetails"></div>
    `;
    container.appendChild(qDiv);

    qDiv.querySelector(".removeQuestionBtn").addEventListener("click", () => qDiv.remove());
    const typeSelect = qDiv.querySelector(".questionType");
    const detailsDiv = qDiv.querySelector(".questionDetails");

    const populateDetails = (type, existing = null) => {
        detailsDiv.innerHTML = "";
        if (type === "mcq") {
            detailsDiv.innerHTML = `
                <label class="form-label">Question</label>
                <input type="text" class="form-control mb-2 questionText" value="${existing?.qText || ''}">
                <label>Options</label>
                <input type="text" class="form-control mb-1 option1" placeholder="Option 1" value="${existing?.option1 || ''}">
                <input type="text" class="form-control mb-1 option2" placeholder="Option 2" value="${existing?.option2 || ''}">
                <input type="text" class="form-control mb-1 option3" placeholder="Option 3" value="${existing?.option3 || ''}">
                <input type="text" class="form-control mb-1 option4" placeholder="Option 4" value="${existing?.option4 || ''}">
                <input type="text" class="form-control correctAnswer" placeholder="Correct Answer" value="${existing?.cAns || ''}">
            `;
        } else if (type === "truefalse") {
            detailsDiv.innerHTML = `
                <label class="form-label">Statement</label>
                <input type="text" class="form-control mb-2 questionText" value="${existing?.qText || ''}">
                <select class="form-select correctAnswer">
                    <option value="True" ${existing?.cAns === "True" ? "selected" : ""}>True</option>
                    <option value="False" ${existing?.cAns === "False" ? "selected" : ""}>False</option>
                </select>
            `;
        } else {
            detailsDiv.innerHTML = `
                <label class="form-label">Question</label>
                <input type="text" class="form-control mb-2 questionText" value="${existing?.qText || ''}">
                <input type="text" class="form-control correctAnswer" placeholder="Expected Answer" value="${existing?.cAns || ''}">
            `;
        }
    };

    typeSelect.addEventListener("change", () => populateDetails(typeSelect.value));
    if (existing) populateDetails(existing.type, existing);
}

addModuleBtn.addEventListener("click", () => addModule());

// ---------------- AUTO LOAD COURSE FROM URL ----------------
const urlParts = window.location.pathname.split('/');
const courseIdFromUrl = urlParts.includes('update') ? urlParts[urlParts.indexOf('update') + 1] : null;

if (courseIdFromUrl && courses.length > 0) {
    const course = courses.find(c => c.id == courseIdFromUrl);
    if (course) {
        document.getElementById("courseTitle").value = course.title;
        courseDescriptionEditor.root.innerHTML = course.description || '';
        overviewEditor.root.innerHTML = course.overview || '';
        requirementsEditor.root.innerHTML = course.requirements || '';
        document.getElementById("courseStatus").checked = course.status === "Active";
        document.getElementById("courseId").value = course.id;
        modulesContainer.innerHTML = "";
        course.modules?.forEach(m => addModule(m));
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// ---------------- SAVE COURSE ----------------
saveBtn.addEventListener("click", async () => {
    const courseId = document.getElementById("courseId").value || null;
    const title = document.getElementById("courseTitle").value.trim();
    const description = courseDescriptionEditor.root.innerHTML.trim();
    const overview = overviewEditor.root.innerHTML.trim();
    const requirements = requirementsEditor.root.innerHTML.trim();
    const status = document.getElementById("courseStatus").checked ? "true" : "false";
    const imageInput = document.getElementById("courseImage");
    const image = imageInput.files[0];

    const modulesData = [];
    document.querySelectorAll("#modulesContainer > div").forEach(modDiv => {
        const moduleTitle = modDiv.querySelector(".moduleTitle").value.trim();
        const chapters = [];
        const questions = [];

        modDiv.querySelectorAll(".chaptersContainer > div").forEach(chDiv => {
            const chEditor = chDiv.querySelector(".chapterEditor .ql-editor");
            chapters.push({
                title: chDiv.querySelector(".chapterTitle").value.trim(),
                desc: chEditor ? chEditor.innerHTML.trim() : "",
                type: chDiv.querySelector(".materialType").value,
            });
        });

        modDiv.querySelectorAll(".questionsContainer > div").forEach(qDiv => {
            const type = qDiv.querySelector(".questionType").value;
            const qText = qDiv.querySelector(".questionText")?.value || "";
            const cAns = qDiv.querySelector(".correctAnswer")?.value || "";
            const question = { type, qText, cAns };
            if (type === "mcq") {
                question.option1 = qDiv.querySelector(".option1")?.value || "";
                question.option2 = qDiv.querySelector(".option2")?.value || "";
                question.option3 = qDiv.querySelector(".option3")?.value || "";
                question.option4 = qDiv.querySelector(".option4")?.value || "";
            }
            questions.push(question);
        });

        modulesData.push({ title: moduleTitle, chapters, questions });
    });

    const formData = new FormData();
    formData.append("title", title);
    formData.append("description", description);
    formData.append("overview", overview);
    formData.append("requirements", requirements);
    formData.append("status", status);
    formData.append("modules_json", JSON.stringify(modulesData));
    if (image) formData.append("image", image);

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = courseId ? `/courses/update/${courseId}/` : `{% url 'create_course' %}`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData,
        });

        if (response.redirected) window.location.href = response.url;
        else if (response.ok) {
            alert("Course saved successfully!");
            location.href = "{% url 'course_table' %}";
        } else {
            alert("Error saving course!");
            console.error(await response.text());
        }
    } catch (error) {
        console.error("Save failed:", error);
        alert("Save failed. Check console for details.");
    }
});
</script>

{% endblock %}
